<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASE para N1 - VSoft</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* SEUS ESTILOS ATUAIS PERMANECEM OS MESMOS */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0d1a2a;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo {
            font-size: 40px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .description {
            font-size: 16px;
            opacity: 0.9;
        }

        main {
            padding: 20px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .menu-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .card-icon {
            font-size: 40px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .card-description {
            font-size: 14px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }
        .logout-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 16px;
            background: linear-gradient(135deg, #dc3545, #b42a35);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }
        .logout-button:hover {
            background: linear-gradient(135deg, #c82333, #a71d24);
        }

        /* --- Estilos do Chatbot (Modal/Tela Cheia) --- */
        #chat-widget-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw; 
            height: 100vh;
            background: rgba(13, 26, 42, 0.95); 
            border-radius: 0;
            box-shadow: none;
            display: none; 
            z-index: 9999;
            align-items: center; 
            justify-content: center;
        }

        .chat-content {
            width: 90%;
            max-width: 900px; 
            height: 90%;
            max-height: 820px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-header {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-header i { margin-right: 10px; }
        #chat-close-btn {
            background: none;
            border: 1px solid white; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #chat-close-btn:hover { background: #2980b9; }

        #chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 15px;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa; 
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        /* Estiliza√ß√£o das Mensagens Aprimorada */
        .message {
            max-width: 90%; 
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
        }
        .user-message {
            background: #3498db;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px; 
        }
        .bot-message {
            background: #e9ecef; 
            color: #333;
            align-self: flex-start;
            margin-right: auto;
            border: none;
            border-bottom-left-radius: 5px; 
            white-space: pre-wrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .bot-message strong { color: #c0392b; }
        .bot-message pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.3;
        }

        #chat-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-top: 1px solid #ddd;
        }
        #estado-filter {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 120px;
            background: white;
        }
        #chat-input {
            flex-grow: 1;
            padding: 12px 20px;
            border: 1px solid #ccc;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        #chat-input:focus { border-color: #3498db; outline: none; }
        #chat-send-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s, transform 0.1s;
        }
        #chat-send-btn:hover { background: #218838; }
        #chat-send-btn:active { transform: scale(0.95); }

        .chat-button {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            margin-top: 8px;
            transition: background 0.2s;
            display: inline-block; 
        }
        .chat-button:hover:not(:disabled) { background: #2980b9; }
        .chat-button:disabled { background: #ccc; cursor: not-allowed; }

        .typing-indicator {
            background: #e0e0e0;
            color: #555;
            padding: 8px 15px;
            border-radius: 20px;
            font-style: italic;
            display: inline-block;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Estilo do Bot√£o Flutuante --- */
        #chat-open-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
        }
        #chat-open-btn i { margin-right: 8px; }

        mark { background: #ffe58a; padding: 0 3px; border-radius: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">VSoft</div>
            <h1>Base para N2</h1>
            <p class="description">Central de guias e documenta√ß√µes t√©cnicas para suporte de N√≠vel 2.</p>
        </header>

        <main>
            <div class="menu-grid">
                <a href="endpoints.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Documenta√ß√£o Endpoints RN</h2>
                        <p class="card-description">Documenta√ß√£o t√©cnica com os Endpoints de RN</p>
                    </div>
                </a>
                <a href="Sergipe.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Documenta√ß√£o Endpoints SE</h2>
                        <p class="card-description">Documenta√ß√£o t√©cnica com os Endpoints de SE</p>
                    </div>
                </a>
                <a href="mshm.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Integra√ß√µes DETRAN-MS / Valid</h2>
                        <p class="card-description">Documenta√ß√£o completa de fluxos, jobs e endpoints de API.</p>
                    </div>
                </a>
                <a href="endpoints_df.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Endpoints Credenciadas DF</h2>
                        <p class="card-description">Documenta√ß√£o completa de fluxos, jobs e endpoints de API.</p>
                    </div>
                </a>
                <a href="SuperPratico.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Integra√ß√µes SuperPr√°tico/ Aulas Praticas</h2>
                        <p class="card-description">Documenta√ß√£o completa de fluxos Do SuperPr√°tico.</p>
                    </div>
                </a>
                <a href="gerenciamento_incidentes.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-share-alt"></i></div>
                    <div>
                        <h2 class="card-title">Politica de gerenciamento de incidentes</h2>
                        <p class="card-description">Documenta√ß√£o completa do gerenciamento de incidente.</p>
                    </div>
                </a>
                <a href="knowledge_manager.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-database"></i></div>
                    <div>
                        <h2 class="card-title">Gerenciar Base de Conhecimento</h2>
                        <p class="card-description">Interface para adicionar e atualizar informa√ß√µes do chatbot por estado (MongoDB).</p>
                    </div>
                </a>
                <a href="menu2.html" class="menu-card">
                    <div class="card-icon"><i class="fas fa-table"></i></div>
                    <div>
                        <h2 class="card-title">Registro Di√°rios</h2>
                        <p class="card-description">Base de registro di√°rio do N2</p>
                    </div>
                </a>
            </div>
        </main>
        <button class="logout-button" onclick="logout()">Sair</button>
    </div>
    
    <div id="chat-widget-container">
        <div class="chat-content">
            <div id="chat-header">
                <div style="display:flex;align-items:center;gap:8px;"><i class="fas fa-robot"></i> Assistente VSoft N2</div>
                <button id="chat-close-btn" onclick="toggleChat()">X</button>
            </div>
            <div id="chat-body">
                <div id="chat-messages">
                    <div class="message bot-message">
                        Ol√°! Sou seu assistente de suporte N2. Minha base de conhecimento √© totalmente gerenciada pelo <strong>MongoDB</strong>.<br><br>
                        Use o filtro de estado e escreva sua d√∫vida. Por exemplo: <em>"SE ve√≠culos"</em> ou escolha o estado no dropdown.
                    </div>
                </div>
                <div id="chat-input-container">
                    <select id="estado-filter">
                        <option value="">Todos os estados</option>
                        <option value="RN">RN</option>
                        <option value="SE">SE</option>
                        <option value="MS">MS</option>
                        <option value="DF">DF</option>
                        <option value="PE">PE</option>
                        <option value="PB">PB</option>
                        <option value="BA">BA</option>
                        <option value="MG">MG</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="AL">AL</option>
                        <option value="CE">CE</option>
                        <option value="TODOS">TODOS</option>
                    </select>
                    <input type="text" id="chat-input" placeholder="Ex: 'N2 de RN', 'SLA cr√≠tico' ou 'Consulta CFC DF'">
                    <button id="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <button id="chat-open-btn" onclick="toggleChat()"><i class="fas fa-comment-dots"></i> Chat N2</button>

    <!-- Fuse.js para pesquisa fuzzy -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

    <script>
        // Vari√°veis Globais para o Chatbot
        let chatMemories = [];
        const VALID_STATES = ['RN', 'DF', 'SE', 'MS', 'PE', 'PB', 'BA', 'MG', 'GO', 'MA', 'AL', 'CE', 'TODOS'];

        // Dicion√°rio de sin√¥nimos para buscas mais inteligentes
        const SYNONYM_MAP = {
            'endpoint': ['api', 'servico', 'url', 'acesso', 'integracao'],
            'sla': ['prazo', 'tempo', 'critico', 'atendimento'],
            'cfc': ['autoescola', 'credenciada', 'centro'],
            'fluxo': ['procedimento', 'passos', 'guia', 'rotina', 'etapa'],
            'job': ['servico', 'tarefa', 'rotina', 'processo'],
            'incidentes': ['problema', 'erro', 'falha', 'indisponibilidade'],
            'consulta': ['pesquisa', 'buscar', 'verificar'],
            'veiculos': ['ve√≠culo', 'carro', 'automovel', 'placa'],
            'aula': ['aulas', 'licao', 'li√ß√£o', 'pratica', 'pr√°tica']
        };

        // Stop Words (Palavras comuns que devem ser ignoradas na busca)
        const STOP_WORDS_PT = [
            'a', 'o', 'as', 'os', 'um', 'uma', 'uns', 'umas', 'de', 'do', 'da', 'dos', 'das', 'e', '√©', 'ou',
            'para', 'com', 'sem', 'em', 'por', 'sobre', 'sob', 'at√©', 'ao', 'aos', '√†', '√†s',
            'que', 'qual', 'quais', 'quem', 'onde', 'como', 'quando', 'porque', 'porqu√™', 'pra', 'pela', 'pelo',
            'dele', 'dela', 'neste', 'nesta', 'isso', 'este', 'esta', 'ser', 'meu', 'minha', 'meus', 'minhas',
            'oii', 'oi', 'ola', 'bom', 'dia', 'tarde', 'noite', 'sobre', 'me', 'meu', 'queria', 'gostaria'
        ];

        // ‚ö†Ô∏è ATEN√á√ÉO: Confirme que esta √© a URL do seu projeto Vercel
        const BACKEND_URL = 'https://base-2-new-new-9xow.vercel.app';

        // Fuse index
        let fuse = null;
        let memoriesIndex = []; // mem√≥rias brutas carregadas
        let lastResults = []; // resultados da √∫ltima busca (para pagina√ß√£o)
        let resultsPage = 0;
        const PAGE_SIZE = 3;

        // Guarda as keywords da √∫ltima busca para highlight
        let lastQueryKeywords = [];

        function logout() {
            localStorage.removeItem('agenteSelecionado');
            localStorage.removeItem('estadoSelecionado');
            window.location.href = 'login.html';
        }

        function toggleChat() {
            const chatWidget = document.getElementById('chat-widget-container');
            const openBtn = document.getElementById('chat-open-btn');

            if (chatWidget.style.display === 'flex') {
                chatWidget.style.display = 'none';
                openBtn.style.display = 'block';
                document.body.style.overflow = 'auto';
            } else {
                chatWidget.style.display = 'flex';
                openBtn.style.display = 'none';
                document.body.style.overflow = 'hidden';
                document.getElementById('chat-input').focus();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('chat-widget-container').style.display === 'flex') {
                toggleChat();
            }
        });

        // --- Helpers de texto e busca ---
        function normalizeText(t) {
            return (t || '')
                .normalize('NFD').replace(/[ÃÄ-\u036f]/g, '')
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function expandTerms(terms) {
            const expanded = new Set();
            const stateTokens = VALID_STATES.map(s => s.toLowerCase());
            
            for (const t of terms) {
                expanded.add(t);
                // N√£o expande tokens de estado
                if (!stateTokens.includes(t)) {
                    const mapped = SYNONYM_MAP[t];
                    if (mapped) mapped.forEach(s => expanded.add(s));
                }
            }
            return Array.from(expanded);
        }

        function highlight(text, terms) {
            let out = text || '';
            for (const term of terms) {
                if (!term || term.length < 2) continue;
                const safe = term.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
                out = out.replace(new RegExp(`(${safe})`, 'ig'), '<mark>$1</mark>');
            }
            return out;
        }

        // Carrega mem√≥rias e cria √≠ndice Fuse
        async function loadMemoriesFromDatabase() {
            appendConsoleLog(`Tentando carregar mem√≥rias de: ${BACKEND_URL}/api/memories`);
            try {
                const response = await fetch(`${BACKEND_URL}/api/memories`);
                if (response.ok) {
                    const data = await response.json();
                    chatMemories = data;
                    memoriesIndex = data.map(m => ({
                        ...m,
                        titulo: (m.texto || '').split(':')[0] || '',
                        texto: m.texto || '',
                        texto_normalizado: normalizeText(m.texto || ''),
                        estado: (m.estado || 'TODOS').toUpperCase()
                    }));

                    const options = {
                        includeScore: true,
                        shouldSort: true,
                        threshold: 0.4, // Mais flex√≠vel
                        keys: [
                            { name: 'titulo', weight: 0.7 },
                            { name: 'texto', weight: 0.25 },
                            { name: 'estado', weight: 0.05 }
                        ],
                        ignoreLocation: true,
                        useExtendedSearch: true
                    };
                    fuse = new Fuse(memoriesIndex, options);
                    appendConsoleLog(`[MongoDB] ${memoriesIndex.length} mem√≥rias indexadas com Fuse.`);
                } else {
                    appendMessage(`[ERRO ${response.status}] A API retornou um status de erro. O backend Vercel pode estar inativo ou ter falhado ao conectar ao MongoDB.`, 'bot-message');
                }
            } catch (error) {
                console.error('Erro de rede/conex√£o:', error);
                appendMessage(`[ERRO DE CONEX√ÉO] N√£o foi poss√≠vel acessar o backend Vercel em **${BACKEND_URL}**. Verifique se a URL est√° correta e se o projeto est√° implantado e ativo.`, 'bot-message');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadMemoriesFromDatabase();
            document.getElementById('chat-open-btn').style.display = 'block';
        });

        // Enviar com Enter
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Envio / ciclo de resposta
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (messageText === '') return;
            appendMessage(messageText, 'user-message');

            const userMessageForSearch = messageText;
            input.value = '';
            showTypingIndicator();
            
            setTimeout(() => {
                const botResponse = getBotResponse(userMessageForSearch);
                appendMessage(botResponse, 'bot-message');
                hideTypeningIndicator();
            }, 600);
        }

        function appendMessage(text, className) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;

            // Processa blocos de c√≥digo
            const codeBlockRegex = /(```json|```|\{)\n?([\s\S]*?)(\n?```|\n\})/g;
            let processedText = text.replace(codeBlockRegex, (match, openTag, content, closeTag) => {
                content = content.replace(/```json|```|{|}/g, '').trim();
                return `\n<pre>${content}</pre>\n`;
            });

            processedText = processedText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.innerHTML = processedText;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function appendConsoleLog(text) {
            console.log(text);
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = 'Digitando...';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            document.getElementById('chat-input').disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
        }

        function hideTypeningIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
            document.getElementById('chat-input').focus();
        }

        // -------------------------------
        // Fun√ß√£o getBotResponse (CORRIGIDA - FILTRO POR ESTADO FUNCIONAL)
        // -------------------------------
        function getBotResponse(message) {
            const estadoFilter = (document.getElementById('estado-filter')?.value || '').toUpperCase();
            const raw = message.trim();
            const normalized = normalizeText(raw);

            // Detecta estado via input dropdown OU texto do usu√°rio
            const stateTokens = VALID_STATES.map(s => s.toLowerCase());
            const possibleState = normalized.split(/\s+/).find(w => stateTokens.includes(w));
            const effectiveState = (estadoFilter || (possibleState ? possibleState.toUpperCase() : '')).toUpperCase();

            // Keywords EXCLUINDO tokens de estado (para evitar conflito)
            let keywords = normalized.split(/\s+/).filter(w => 
                w.length > 1 && 
                !STOP_WORDS_PT.includes(w) && 
                !stateTokens.includes(w) // Remove tokens de estado das keywords
            );
            
            // Expandir sin√¥nimos (sem tokens de estado)
            keywords = expandTerms(keywords);

            // Salva para highlight/pagina√ß√£o
            lastQueryKeywords = keywords.slice();

            // FILTRO POR ESTADO - CORRE√á√ÉO PRINCIPAL
            let pool = memoriesIndex;
            if (effectiveState && effectiveState !== 'TODOS') {
                pool = memoriesIndex.filter(m => 
                    (m.estado || '').toUpperCase() === effectiveState
                );
            }

            // Se n√£o h√° termos (usu√°rio s√≥ abriu sem digitar), mostra √∫ltimos registros do estado
            if (keywords.length === 0) {
                const list = pool.sort((a,b) => new Date(b.dataHora) - new Date(a.dataHora)).slice(0, 6);
                if (list.length === 0) return `N√£o encontrei mem√≥rias para o estado ${effectiveState || 'TODOS'}. Use 'Gerenciar Base de Conhecimento' para inserir.`;
                lastResults = list;
                resultsPage = 0;
                return formatResultsPage();
            }

            // BUSCA FLEX√çVEL: Encontra registros que contenham PELO MENOS UMA das keywords
            let results = pool.filter(memory => {
                const memoryText = normalizeText(memory.texto || '');
                const memoryTitle = normalizeText(memory.titulo || '');
                const fullText = memoryTitle + ' ' + memoryText;
                
                // Verifica se PELO MENOS UMA keyword aparece no t√≠tulo OU texto
                return keywords.some(keyword => 
                    memoryText.includes(keyword) || memoryTitle.includes(keyword)
                );
            });

            // Se n√£o encontrou com busca flex√≠vel, usa Fuse para busca fuzzy
            if (results.length === 0 && fuse) {
                try {
                    const tempFuse = new Fuse(pool, { 
                        includeScore: true, 
                        threshold: 0.5, // Mais flex√≠vel
                        keys: ['titulo', 'texto'], 
                        ignoreLocation: true 
                    });
                    
                    const fuseResults = tempFuse.search(keywords.join(' '), { limit: 20 });
                    results = fuseResults.map(r => ({ ...r.item, __fuseScore: r.score }));
                } catch (e) {
                    console.log('Fuse search failed, using fallback');
                }
            }

            // Ordena por relev√¢ncia (mais keywords matching = mais relevante)
            results = results.map(memory => {
                let score = 0;
                const memoryText = normalizeText(memory.texto || '');
                const memoryTitle = normalizeText(memory.titulo || '');
                
                // Pontua por cada keyword encontrada
                keywords.forEach(keyword => {
                    if (memoryTitle.includes(keyword)) score += 3; // Match no t√≠tulo = mais relevante
                    if (memoryText.includes(keyword)) score += 1;  // Match no texto = menos relevante
                });
                
                // B√¥nus por matching exato de estado
                if (effectiveState && memory.estado === effectiveState) score += 2;
                
                // B√¥nus extra se encontrar TODAS as keywords (busca perfeita)
                const allKeywordsMatch = keywords.every(keyword => 
                    memoryText.includes(keyword) || memoryTitle.includes(keyword)
                );
                if (allKeywordsMatch) score += 5;
                
                return { ...memory, _score: score };
            }).sort((a, b) => b._score - a._score);

            if (results.length === 0) {
                return `Desculpe, n√£o encontrei uma resposta na base de conhecimento (MongoDB) para "${raw}" no estado ${effectiveState || 'TODOS'}. Tente termos diferentes ou v√° em 'Gerenciar Base de Conhecimento'.`;
            }

            lastResults = results;
            resultsPage = 0;
            return formatResultsPage();
        }

        // -------------------------------
        // formata√ß√£o / pagina√ß√£o / utilit√°rios
        // -------------------------------
        function formatResultsPage() {
            const start = resultsPage * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const page = lastResults.slice(start, end);
            if (page.length === 0) return 'Nenhum resultado nesta p√°gina.';

            const total = lastResults.length;
            const listFormatted = page.map(m => {
                const date = m.dataHora ? new Date(m.dataHora).toLocaleDateString('pt-BR') : '';
                const parts = (m.texto || '').split(':');
                const title = parts[0] || m.titulo || 'Sem t√≠tulo';
                const content = parts.length > 1 ? parts.slice(1).join(':') : m.texto || '';
                // usa lastQueryKeywords que foi salvo durante a busca
                const keywordsFromQuery = lastQueryKeywords || [];
                const highlighted = highlight(content, keywordsFromQuery);
                const img = m.imagemUrl ? `<br><img src="${m.imagemUrl}" style="max-width:100%;border-radius:6px;margin-top:8px;">` : '';
                const id = m._id || m.id || (m.idMemoria || '') || '';
                const actions = `<br><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button class="chat-button" onclick="showFullMemory('${id}')">Ver Mais</button><button class="chat-button" onclick="sendFeedback('${id}', true)">üëç</button><button class="chat-button" onclick="sendFeedback('${id}', false)">üëé</button></div>`;
                return `**[${m.estado || 'TODOS'}] ${title}**\n\n${highlighted} (Agente: ${m.agente || '‚Äî'}, ${date})${img}${actions}`;
            }).join('\n\n---\n\n');

            const remaining = Math.max(0, total - ((resultsPage + 1) * PAGE_SIZE));
            const moreBtn = remaining > 0 ? `\n\n<button class="chat-button" onclick="showMoreResults()">Mostrar mais (${remaining} restantes)</button>` : '\n\n*Fim da lista.*';
            return `Encontrei **${total}** refer√™ncias.\n\n${listFormatted}${moreBtn}`;
        }

        function collectLastQueryKeywords() {
            return lastQueryKeywords || [];
        }

        function showMoreResults() {
            resultsPage += 1;
            appendMessage(formatResultsPage(), 'bot-message');
        }

        function showFullMemory(id) {
            const mem = memoriesIndex.find(m => (m._id === id || m.id === id || (m.idMemoria === id)));
            if (!mem) { appendMessage('Conte√∫do n√£o encontrado', 'bot-message'); return; }
            appendMessage(`**${mem.titulo}**\n\n${mem.texto}\n\n(Agente: ${mem.agente}, ${new Date(mem.dataHora).toLocaleString('pt-BR')})`, 'bot-message');
        }

        async function sendFeedback(id, positive) {
            if (!id) { appendMessage('ID da mem√≥ria inv√°lido para feedback.', 'bot-message'); return; }
            try {
                await fetch(`${BACKEND_URL}/api/memories/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, positive })
                });
                appendMessage(positive ? 'Obrigado pelo feedback positivo!' : 'Obrigado, registramos o feedback e iremos revisar.', 'bot-message');
            } catch (e) {
                appendMessage('Erro ao enviar feedback.', 'bot-message');
            }
        }

    </script>
</body>
</html>

